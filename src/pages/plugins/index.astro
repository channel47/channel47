---
// src/pages/plugins/index.astro
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import AsciiPluginIcon from '../../components/AsciiPluginIcon.astro';
import AsciiHeader from '../../components/AsciiHeader.astro';
import mergedPlugins from '../../data/merged-plugins.json';
import '../../styles/components/plugin-index.css';

const plugins = await getCollection('plugins', ({ data }) => !data.draft);

// Merge with marketplace data
const enrichedPlugins = plugins.map(plugin => {
  const marketplaceData = mergedPlugins.find(p => p.name === plugin.slug);
  return {
    ...plugin,
    marketplaceData,
    featured: plugin.data.featured || false
  };
});

// Sort: featured first, then by slug
enrichedPlugins.sort((a, b) => {
  if (a.featured && !b.featured) return -1;
  if (!a.featured && b.featured) return 1;
  return a.slug.localeCompare(b.slug);
});

// Get unique categories
const categories = ['all', ...new Set(mergedPlugins.map(p => p.category).filter(Boolean))];

---

<BaseLayout
  title="Plugins"
  description="Battle-tested Claude Code plugins from daily workflows."
>
  <div class="plugin-index-container">
    <div class="plugin-header">
      <AsciiHeader text="TOOLS" />
    </div>

    <div class="plugin-controls">
      <div class="plugin-filters">
        <button class="filter-btn active" data-filter="all">
          [ All ]
        </button>
        {categories.slice(1).map(cat => (
          <button class="filter-btn" data-filter={cat}>
            {cat}
          </button>
        ))}
      </div>
    </div>

    <div class="plugin-grid">
      {enrichedPlugins.map(({ slug, data, marketplaceData, featured }) => {
        const name = marketplaceData?.name || slug;
        const category = marketplaceData?.category || 'uncategorized';

        return (
          <a
            href={`/plugins/${slug}`}
            class={`plugin-card ${featured ? 'plugin-card--featured' : ''}`}
            data-category={category}
          >
            <div class="plugin-card__content">
              <div class="plugin-card__top">
                <span class="plugin-card__category" data-category={category}>
                  {category}
                </span>
                <span class="plugin-card__version">v{marketplaceData?.version || '0.0.0'}</span>
              </div>

              <h2 class="plugin-card__title">
                {name}
              </h2>

              <p class="plugin-card__desc">
                {marketplaceData?.description || ''}
              </p>
            </div>

            {data.asciiIcon && (
              <div class="plugin-card__icon">
                <AsciiPluginIcon
                  icon={data.asciiIcon}
                  color={data.iconColor}
                  size="large"
                />
              </div>
            )}
            
            <div class="plugin-card__hover-indicator"></div>
          </a>
        );
      })}
    </div>
  </div>
</BaseLayout>

<script>
  // Category filter functionality
  const filters = document.querySelectorAll('.filter-btn');
  const cards = document.querySelectorAll('.plugin-card');

  filters.forEach(filter => {
    filter.addEventListener('click', () => {
      const category = filter.getAttribute('data-filter');

      // Update active state
      filters.forEach(f => {
        f.classList.remove('active');
        if (f !== filter) {
           f.textContent = f.textContent?.replace('[ ', '').replace(' ]', '');
        }
      });
      
      filter.classList.add('active');
      if (!filter.textContent?.includes('[')) {
        filter.textContent = `[ ${filter.textContent?.trim()} ]`;
      }

      // Filter cards
      cards.forEach(card => {
        const cardCategory = card.getAttribute('data-category');
        if (category === 'all' || cardCategory === category) {
          (card as HTMLElement).style.display = 'flex';
          // Add fade in animation
          (card as HTMLElement).style.opacity = '0';
          setTimeout(() => {
            (card as HTMLElement).style.opacity = '1';
          }, 50);
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    });
  });
</script>
