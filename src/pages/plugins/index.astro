---
// src/pages/plugins/index.astro
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import AsciiIcon from '../../components/AsciiIcon.astro';
import mergedPlugins from '../../data/merged-plugins.json';
import '../../styles/components/plugin-spread.css';

const plugins = await getCollection('plugins', ({ data }) => !data.draft);

// Merge with marketplace data
const enrichedPlugins = plugins.map(plugin => {
  const marketplaceData = mergedPlugins.find(p => p.name === plugin.slug);
  return {
    ...plugin,
    marketplaceData,
    featured: plugin.data.featured || false
  };
});

// Sort: featured first, then by slug
enrichedPlugins.sort((a, b) => {
  if (a.featured && !b.featured) return -1;
  if (!a.featured && b.featured) return 1;
  return a.slug.localeCompare(b.slug);
});

// Get unique categories
const categories = ['all', ...new Set(mergedPlugins.map(p => p.category))];

// Assign spread sizes for asymmetric layout
function getSpreadSize(index: number, isFeatured: boolean): string {
  if (isFeatured) return 'featured';

  const pattern = index % 5;
  if (pattern === 0) return 'large';
  if (pattern === 1 || pattern === 2) return 'medium';
  return 'small';
}

// Split plugin names for weight mixing - first part (before hyphen) bold, rest regular
function splitName(name: string): { first: string; second: string } {
  // First try splitting on hyphens (common in plugin names)
  if (name.includes('-')) {
    const parts = name.split('-');
    return {
      first: parts[0],
      second: '-' + parts.slice(1).join('-')
    };
  }

  // Fallback: try splitting on spaces
  const words = name.split(' ');
  if (words.length > 1) {
    return {
      first: words[0],
      second: words.slice(1).join(' ')
    };
  }

  // Single word with no hyphens or spaces - keep as one weight
  return { first: name, second: '' };
}
---

<BaseLayout
  title="Plugins"
  description="Battle-tested Claude Code plugins from daily workflows."
>
  <div class="plugin-index">
    <header class="plugin-index__hero">
      <h1 class="plugin-index__title">
        <span style="font-weight: 700;">Tools</span>
        <span style="font-weight: 300;">that work</span>
      </h1>
      <p class="plugin-index__subtitle">
        Battle-tested Claude Code plugins from daily workflows. All free. Quality over quantity.
      </p>
    </header>

    <div class="plugin-index__filters">
      <button class="plugin-filter plugin-filter--active" data-filter="all">
        All
      </button>
      {categories.slice(1).map(cat => (
        <button class="plugin-filter" data-filter={cat}>
          {cat}
        </button>
      ))}
    </div>

    <div class="plugin-spreads">
      {enrichedPlugins.map(({ slug, data, marketplaceData, featured }, index) => {
        const size = getSpreadSize(index, featured);
        const name = marketplaceData?.name || slug;
        const nameParts = splitName(name);

        const isAsciiArt = slug === 'ascii-art';
        const category = marketplaceData?.category || 'default';

        return (
          <a
            href={`/plugins/${slug}`}
            class={`plugin-spread plugin-spread--${size}`}
            data-category={marketplaceData?.category || 'uncategorized'}
          >
            <div class="plugin-spread__category" data-category={marketplaceData?.category}>
              {marketplaceData?.category || 'plugin'}
            </div>

            <h2 class="plugin-spread__name">
              <span style="font-weight: 800;">{nameParts.first}</span>{nameParts.second && <span style="font-weight: 400;">{nameParts.second}</span>}
            </h2>

            <p class="plugin-spread__description">
              {marketplaceData?.description || ''}
            </p>

            <div class="plugin-spread__meta">
              <span>by {marketplaceData?.author || 'Unknown'}</span>
              <span>·</span>
              <span>v{marketplaceData?.version || '0.0.0'}</span>
            </div>

            {isAsciiArt && (
              <div class="plugin-spread__ascii-preview">╭──────────╮
│  ASCII   │
│   ART    │
╰──────────╯</div>
            )}

            {size === 'featured' && marketplaceData?.name && (
              <div class="plugin-spread__code">
                claude plugins install {marketplaceData.name}
              </div>
            )}
          </a>
        );
      })}
    </div>
  </div>
</BaseLayout>

<script>
  // Category filter functionality
  const filters = document.querySelectorAll('.plugin-filter');
  const spreads = document.querySelectorAll('.plugin-spread');

  filters.forEach(filter => {
    filter.addEventListener('click', () => {
      const category = filter.getAttribute('data-filter');

      // Update active state
      filters.forEach(f => f.classList.remove('plugin-filter--active'));
      filter.classList.add('plugin-filter--active');

      // Filter spreads
      spreads.forEach(spread => {
        const spreadCategory = spread.getAttribute('data-category');
        if (category === 'all' || spreadCategory === category) {
          (spread as HTMLElement).style.display = 'block';
        } else {
          (spread as HTMLElement).style.display = 'none';
        }
      });
    });
  });

  // Scroll-triggered fade-in (optional)
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          setTimeout(() => {
            entry.target.classList.add('plugin-spread--visible');
            entry.target.classList.remove('plugin-spread--animate');
          }, index * 50); // Stagger by 50ms
        }
      });
    },
    { threshold: 0.1 }
  );

  document.querySelectorAll('.plugin-spread').forEach((spread) => {
    spread.classList.add('plugin-spread--animate');
    observer.observe(spread);
  });
</script>
