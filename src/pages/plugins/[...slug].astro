---
// src/pages/plugins/[...slug].astro
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import mergedPlugins from '../../data/merged-plugins.json';
import '../../styles/components/plugin-page.css';

export async function getStaticPaths() {
  const plugins = await getCollection('plugins', ({ data }) => !data.draft);

  return plugins.map(plugin => {
    const marketplaceData = mergedPlugins.find(p => p.name === plugin.slug);

    return {
      params: { slug: plugin.slug },
      props: {
        plugin,
        marketplaceData,
      },
    };
  });
}

const { plugin, marketplaceData } = Astro.props;
const { Content } = await plugin.render();

type RelatedPost = {
  title: string;
  slug: string;
  date: string;
};

const relatedPosts = (marketplaceData?.relatedPosts || []) as RelatedPost[];

// Format metadata
const version = marketplaceData?.version || '1.0.0';
const category = marketplaceData?.category || 'tools';
const name = marketplaceData?.name || plugin.slug;
const description = marketplaceData?.description || '';
---

<BaseLayout title={name} description={description}>
  <article class="editorial-article">
    <!-- Hero Area -->
    <div class="article-hero">
      <div class="article-meta">
        v{version} • {category.toUpperCase()}
      </div>
      <h1 class="article-title">{name}</h1>
      <p class="article-lead">{description}</p>
    </div>

    <!-- Installation Section -->
    <section class="article-section">
      <h2 class="section-header">Installation</h2>
      <div class="editorial-block">
        <details>
          <summary>First time? Add Channel 47 marketplace first</summary>
          <div>
            <p style="font-size: var(--text-sm); color: var(--color-text-muted); margin-bottom: var(--space-3);">
              Step 1: Add marketplace
            </p>
            <code class="editorial-block__code">
              /plugin marketplace add ctrlswing/channel47-marketplace
            </code>
          </div>
        </details>

        <p class="editorial-block__intro">Install plugin:</p>
        <code class="editorial-block__code">
          /plugin install {name}@channel47
        </code>

        <div class="editorial-block__meta">
          <span>v{version}</span>
          <span>•</span>
          <span style="text-transform: capitalize;">{category}</span>
        </div>
      </div>
    </section>

    <!-- Content -->
    <div class="article-content">
      <Content />
    </div>

    <!-- Related Posts Section -->
    {relatedPosts.length > 0 && (
      <section class="article-section">
        <h2 class="section-header">See it in action</h2>
        <ul class="related-list">
          {relatedPosts.map(post => (
            <li class="related-list__item">
              <a href={`/blog/${post.slug}`} class="related-list__link">
                {post.title}
              </a>
              <span class="related-list__date">
                {new Date(post.date).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  year: 'numeric'
                })}
              </span>
            </li>
          ))}
        </ul>
      </section>
    )}

    <!-- Footer -->
    <footer class="article-footer">
      <a href="/plugins">&larr; Back to plugins</a>
    </footer>
  </article>
</BaseLayout>
